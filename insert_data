#! usr/bin/bash

insert_intoT() {
if [[ "$mode" = "sql" ]]
then
    echo "Enter INSERT command:"
    echo "Example: insert into table1 values (10, mariam, 5000)"
    read -r cmd

    # Lowercase
    cmd=$(echo "$cmd" | tr '[:upper:]' '[:lower:]')

    # Basic syntax check
    if [[ ! "$cmd" =~ ^insert[[:space:]]+into[[:space:]]+([a-zA-Z0-9_]+)[[:space:]]+values[[:space:]]*\(.*\)$ ]]; then
        echo "Invalid INSERT syntax!"
        return 1
    fi

    # Extract table name
    table_name=$(echo "$cmd" | awk '{print $3}')

    if [[ ! -f "$table_name" ]]; then
        echo "Table '$table_name' does not exist!"
        return 1
    fi

    if [[ ! -f "$table_name.meta" ]]; then
        echo "Metadata file missing!"
        return 1
    fi

    # Extract values between parentheses
    values_str="${cmd#*\(}"
    values_str="${values_str%\)}"

    IFS=',' read -ra values <<< "$values_str"
    for i in "${!values[@]}"; do
        values[$i]=$(echo "${values[$i]}" | xargs)
    done

    # Read meta
    cols=()
    types=()
    pk_index=-1

    idx=0
    while IFS=':' read -r c t pk; do
        cols+=("$c")
        types+=("$t")
        if [[ "$pk" == "pk" ]]; then
            pk_index=$idx
        fi
        ((idx++))
    done < "$table_name.meta"

    # Check values count
    if [[ ${#values[@]} -ne ${#cols[@]} ]]; then
        echo "Error: Expected ${#cols[@]} values, got ${#values[@]}"
        return 1
    fi

    # PK validation
    if [[ $pk_index -ge 0 ]]; then
        pk_val="${values[$pk_index]}"
        if grep -q "^$pk_val:" "$table_name"; then
            echo "Error: PK '$pk_val' already exists!"
            return 1
        fi
    fi

    # Datatype validation function
    check_type() {
        local type="$1"
        local val="$2"
        case $type in
            int)
                [[ "$val" =~ ^[0-9]+$ ]] || return 1
                ;;
            float)
                [[ "$val" =~ ^[0-9]+(\.[0-9]+)?$ ]] || return 1
                ;;
            char)
                [[ "$val" =~ ^[a-zA-Z]+$ ]] || return 1
                ;;
            *)
                return 1
                ;;
        esac
        return 0
    }

    # Validate types
    for i in "${!values[@]}"; do
        if ! check_type "${types[$i]}" "${values[$i]}"; then
            echo "Datatype error: '${values[$i]}' is not ${types[$i]}"
            return 1
        fi
    done

    # Build new row
    new_row=$(IFS=':'; echo "${values[*]}")

    # Insert into table
    echo "$new_row" >> "$table_name"
    echo "Row inserted successfully into $table_name"
#########################MAIN MENU#################################
else

    echo "----- Insert Into Table (Menu Mode) -----"

    read -p "Enter table name: " table_name
    table_name=$(echo "$table_name" | xargs)

    if [[ ! -f "$table_name" ]]; then
        echo "Table '$table_name' does not exist!"
        return 1
    fi

    if [[ ! -f "$table_name.meta" ]]; then
        echo "Metadata file missing!"
        return 1
    fi

    cols=()
    types=()
    pk_index=-1
    idx=0
    while IFS=':' read -r c t pk; do
        cols+=("$c")
        types+=("$t")
        if [[ "$pk" == "pk" ]]; then
            pk_index=$idx
        fi
        ((idx++))
    done < "$table_name.meta"

    values=()

    for i in "${!cols[@]}"; do
        while true; do
            read -p "Enter value for column '${cols[$i]}' (${types[$i]}): " val
            val=$(echo "$val" | xargs)

            case "${types[$i]}" in
                int)
                    [[ "$val" =~ ^[0-9]+$ ]] || { echo "Invalid int!"; continue; }
                    ;;
                float)
                    [[ "$val" =~ ^[0-9]+(\.[0-9]+)?$ ]] || { echo "Invalid float!"; continue; }
                    ;;
                char)
                    [[ "$val" =~ ^[a-zA-Z]+$ ]] || { echo "Invalid char!"; continue; }
                    ;;
            esac

            if [[ $i -eq $pk_index ]]; then
                if grep -q "^$val:" "$table_name"; then
                    echo "Primary key '$val' already exists!"
                    continue
                fi
            fi

            values+=("$val")
            break
        done
    done

    new_row=$(IFS=':'; echo "${values[*]}")

    echo "$new_row" >> "$table_name"
    echo "Row inserted successfully into $table_name"
fi   
    
    
}
