#! /usr/bin/bash 

Delete_fromT() {
if [[ "$mode" = "menu" ]]
then
echo "_________________________________"
echo "      Delete From Table          "
echo "_________________________________"

read -p "enter table name: " table_name
table_name=$(echo "$table_name" | xargs)

if [[ ! -f "$table_name" ]]; then
    echo "$table_name not found!"
    exit 1
fi

if [[ ! "$table_name" =~ ^[a-zA-Z][a-zA-Z0-9]*$ ]]; then
    echo "Invalid table name"
    exit 1
fi

num_columns=$(head -n 1 "$table_name" | awk -F: '{print NF}')

echo "1. Truncate table "
echo " "
echo "2. Delete specific column"
echo " "
echo "3. Delete row by value"
echo " "

read -p "Enter your choice: " choice
echo "                            "
echo "         Header             "
echo "$(head -n 1 "$table_name" | column -t -s ":" )"

case $choice in
    1)
        echo -e "\nAre you sure you want to delete the content of this table? (yes/no): "
        read confirm
        if [[ ${confirm,,} =~ ^y ]]; then
            head -n 1 "$table_name" > temp
            mv temp "$table_name"
            echo "This table $table_name is now empty (header kept)."
        else
            echo "The deletion of table cancelled."
        fi
        ;;

    2)
        while true; do
            echo "Please specify field number to delete or EXIT"
            read FN 2> /dev/null

            if [[ $FN =~ ^(exit|EXIT|Exit)$ ]]; then
                break
            fi

            if ! [[ $FN =~ ^[0-9]+$ ]]; then
                echo "Invalid input! Please enter a number."
                continue
            fi

            if (( FN < 1 || FN > num_columns )); then
                echo "Field number out of range! Must be 1 to $num_columns"
                continue
            fi
            
             if [[ $(awk -F":" -v col_num="$FN" 'NR == col_num && ($0 ~ /:pk($|:)/ || $0 ~ /:pk,ai($|:)/) { print "true"; exit }' "${table_name}.meta") == "true" ]]; then
    echo -e "Error: The specified column is a primary key and cannot be deleted"
    continue
fi

            awk -F":" -v col="$FN" '
		{
		    output = ""
		    for (i=1; i<=NF; i++) {
			if (i != col) {
			    # Append the field and a separator
			    output = output $i ":"
			}
		    }
		    # Remove the trailing separator and print
		    sub(/:$/, "", output)
		    print output
		}
		' "$table_name" > temp

            mv temp "$table_name"

            echo "Column $FN deleted successfully."
            break
        done
        ;;

    3)
        while true; do
            echo "Please specify field number to search for or EXIT"
            read FN 2> /dev/null

            if [[ $FN =~ ^(exit|EXIT|Exit)$ ]]; then
                break
            fi

            if ! [[ $FN =~ ^[0-9]+$ ]]; then
                echo "Invalid input! Please enter a number."
                continue
            fi

            if (( FN < 1 || FN > num_columns )); then
                echo "Field number out of range! Must be 1 to $num_columns"
                continue
            fi

            break
        done

        read -r -p "Enter value to search and delete: " search_value

        # Delete the matching rows (case-insensitive)
        awk -F":" -v col="$FN" -v val="$search_value" 'BEGIN{IGNORECASE=1} NR==1{print; next} $col !~ val' "$table_name" > temp
        mv temp "$table_name"

        echo "Rows with value '$search_value' in column $FN have been deleted."
        ;;

    *)
        echo "Invalid choice!"
        ;;
esac
#########################MAIN MENU#################################
else
    echo "Enter your command:"
    read -r cmd
    cmd=$(echo "$cmd" | xargs)
    cmd=$(echo "$cmd" | tr '[:upper:]' '[:lower:]')

    set -- $cmd
    word_count=$#

    # TRUNCATE TABLE
    if [[ "$1" == "truncate" && "$2" == "table" && $word_count -eq 3 ]]; then
        table_name="$3"
        if [[ ! -f "$table_name" ]]; then
            echo "Table '$table_name' not found!"
            return 1
        fi

        head -n 1 "$table_name" > temp
        mv temp "$table_name"
        echo "Table '$table_name' truncated (header kept)."
        return
    fi

    # DELETE FROM table_name WHERE col=value
    if [[ "$1" == "delete" && "$2" == "from" && "$4" == "where" && $word_count -eq 5 ]]; then
        table_name="$3"
        condition="$5"

        if [[ ! -f "$table_name" ]]; then
            echo "Table '$table_name' not found!"
            return 1
        fi

        # Parse condition col=value
        if [[ ! "$condition" =~ ^([a-zA-Z0-9_]+)=(.+)$ ]]; then
            echo "Invalid WHERE condition syntax!"
            return 1
        fi

        col_name="${BASH_REMATCH[1]}"
        val="${BASH_REMATCH[2]}"

        meta="$table_name.meta"
        col_index=-1
        pk_index=-1
        i=0
        while IFS=':' read -r cname ctype flag; do
            if [[ "$cname" == "$col_name" ]]; then
                col_index=$i
            fi
            [[ "$flag" == "pk" ]] && pk_index=$i
            ((i++))
        done < "$meta"

        if [[ $col_index -eq -1 ]]; then
            echo "Column '$col_name' not found!"
            return 1
        fi

        #if [[ $col_index -eq $pk_index ]]; then
        #    echo "Cannot delete using primary key column!"
        #    return 1
        #fi

        # Delete rows
        awk -F":" -v col="$((col_index+1))" -v val="$val" 'BEGIN{IGNORECASE=1} NR==1{print; next} $col !~ val' "$table_name" > temp
        mv temp "$table_name"
        echo "Rows where '$col_name'='$val' deleted from '$table_name'."
        return
    fi

    echo "Syntax error!!"

fi
}

#Delete_fromT

